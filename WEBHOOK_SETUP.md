# Настройка Webhook для ЮKassa

## Описание

Webhook позволяет получать автоматические уведомления от ЮKassa о статусе платежей в реальном времени, без необходимости периодически проверять статус.

## URL Webhook'а

```
https://admin.universaltools.pro/webhook/yookassa
```

## Настройка в ЮKassa

### 1. Войдите в личный кабинет ЮKassa
- Перейдите на https://yookassa.ru/
- Войдите в личный кабинет

### 2. Настройте webhook
- Перейдите в раздел "Настройки" → "Уведомления"
- Добавьте новый webhook:
  - **URL**: `https://admin.universaltools.pro/webhook/yookassa`
  - **События**: 
    - `payment.succeeded` - платеж успешно завершен
    - `payment.waiting_for_capture` - платеж ожидает подтверждения
    - `payment.canceled` - платеж отменен
    - `refund.succeeded` - возврат успешно завершен

### 3. Проверка работы
После настройки webhook'а, при создании платежа ЮKassa будет автоматически:
1. Отправлять уведомления на наш сервер
2. Обновлять статус платежа в базе данных
3. Создавать подписку в 3xUI при успешной оплате
4. Отправлять уведомление пользователю в Telegram

## Проверка статуса webhook'а

```bash
# Проверка здоровья сервера
curl https://admin.universaltools.pro/webhook/health

# Проверка статуса systemd сервиса
systemctl status seavpn-webhook

# Просмотр логов
journalctl -u seavpn-webhook -f
```

## Логика работы

1. **Создание платежа**: Пользователь создает платеж в боте
2. **Ожидание оплаты**: Платеж находится в статусе "pending"
3. **Webhook уведомление**: ЮKassa отправляет уведомление о статусе
4. **Обработка**: Наш сервер обрабатывает уведомление:
   - Обновляет статус платежа в БД
   - При успешной оплате создает подписку в 3xUI
   - Отправляет уведомление пользователю
   - Начисляет реферальные бонусы

## Безопасность

- Webhook проверяет подпись от ЮKassa (пока отключено для тестирования)
- Все операции логируются
- Ошибки обрабатываются и логируются

## Устранение неполадок

### Webhook не работает
1. Проверьте статус сервиса: `systemctl status seavpn-webhook`
2. Проверьте логи: `journalctl -u seavpn-webhook -f`
3. Проверьте доступность: `curl https://admin.universaltools.pro/webhook/health`

### Платежи не обрабатываются
1. Проверьте настройки webhook'а в ЮKassa
2. Проверьте логи webhook сервера
3. Убедитесь, что URL webhook'а правильный

### Перезапуск сервиса
```bash
systemctl restart seavpn-webhook
```
