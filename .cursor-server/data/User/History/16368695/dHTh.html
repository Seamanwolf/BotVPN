{% extends "base.html" %}

{% block title %}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>
        <div>
            <button class="btn btn-primary" onclick="refreshUsers()">
                <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
            </button>
        </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <input type="text" class="form-control" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email...">
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="statusFilter">
                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                        <option value="inactive">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="subscriptionFilter">
                        <option value="">–í—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏</option>
                        <option value="has_subscription">–° –ø–æ–¥–ø–∏—Å–∫–æ–π</option>
                        <option value="no_subscription">–ë–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary" onclick="applyFilters()">
                        <i class="fas fa-filter"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped" id="usersTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ò–º—è</th>
                            <th>Telegram ID</th>
                            <th>Email</th>
                            <th>–ú–æ–Ω–µ—Ç—ã</th>
                            <th>–ü–æ–¥–ø–∏—Å–∫–∏</th>
                            <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.id }}</td>
                            <td>{{ user.full_name or '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</td>
                            <td>{{ user.telegram_id }}</td>
                            <td>{{ user.email or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</td>
                            <td>
                                <span class="badge bg-warning">{{ user.bonus_coins }} ü™ô</span>
                            </td>
                            <td>
                                {% set user_subscriptions = subscriptions|selectattr("user_id", "equalto", user.id)|list %}
                                {% if user_subscriptions %}
                                    <span class="badge bg-success">{{ user_subscriptions|length }} –∞–∫—Ç–∏–≤–Ω—ã—Ö</span>
                                {% else %}
                                    <span class="badge bg-secondary">–ù–µ—Ç –ø–æ–¥–ø–∏—Å–æ–∫</span>
                                {% endif %}
                            </td>
                            <td>{{ user.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" onclick="viewUserDetails({{ user.id }})" title="–î–µ—Ç–∞–ª–∏">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewUserSubscriptions({{ user.id }})" title="–ü–æ–¥–ø–∏—Å–∫–∏">
                                    <i class="fas fa-list"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteUser({{ user.id }}, '{{ user.full_name or user.telegram_id }}')" title="–£–¥–∞–ª–∏—Ç—å">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
<div class="modal fade" id="userDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–µ—Ç–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userDetailsContent">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
<div class="modal fade" id="userSubscriptionsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ü–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userSubscriptionsContent">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
<div class="modal fade" id="deleteUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è <strong id="deleteUserName"></strong>?</p>
                <p class="text-danger">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteUser()">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentUserId = null;

function viewUserDetails(userId) {
    fetch(`/api/user/${userId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const user = data.user;
                const content = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                            <p><strong>ID:</strong> ${user.id}</p>
                            <p><strong>–ò–º—è:</strong> ${user.full_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                            <p><strong>Telegram ID:</strong> ${user.telegram_id}</p>
                            <p><strong>Email:</strong> ${user.email || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                            <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${user.phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h6>
                            <p><strong>–ë–æ–Ω—É—Å–Ω—ã–µ –º–æ–Ω–µ—Ç—ã:</strong> ${user.bonus_coins} ü™ô</p>
                            <p><strong>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥:</strong> <code>${user.referral_code}</code></p>
                            <p><strong>–ü—Ä–∏–≥–ª–∞—à–µ–Ω –æ—Ç:</strong> ${user.referred_by || '–ù–µ—Ç'}</p>
                            <p><strong>–ü–µ—Ä–≤–∞—è –ø–æ–∫—É–ø–∫–∞:</strong> ${user.has_made_first_purchase ? '–î–∞' : '–ù–µ—Ç'}</p>
                            <p><strong>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong> ${new Date(user.created_at).toLocaleString()}</p>
                        </div>
                    </div>
                `;
                document.getElementById('userDetailsContent').innerHTML = content;
                new bootstrap.Modal(document.getElementById('userDetailsModal')).show();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }
        });
}

function viewUserSubscriptions(userId) {
    fetch(`/api/user/${userId}/subscriptions`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const subscriptions = data.subscriptions;
                let content = '<h6>–ü–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h6>';
                
                if (subscriptions.length > 0) {
                    content += `
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>–ü–ª–∞–Ω</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                        <th>–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    subscriptions.forEach(sub => {
                        const daysLeft = Math.ceil((new Date(sub.expires_at) - new Date()) / (1000 * 60 * 60 * 24));
                        const statusBadge = sub.status === 'active' ? 
                            `<span class="badge bg-success">–ê–∫—Ç–∏–≤–Ω–∞</span>` : 
                            `<span class="badge bg-secondary">${sub.status}</span>`;
                        
                        content += `
                            <tr>
                                <td>${sub.id}</td>
                                <td>${sub.plan_name}</td>
                                <td>${statusBadge}</td>
                                <td>${new Date(sub.expires_at).toLocaleDateString()} (${daysLeft} –¥–Ω.)</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info" onclick="viewSubscriptionDetails(${sub.id})">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    content += '</tbody></table></div>';
                } else {
                    content += '<p class="text-muted">–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –ø–æ–¥–ø–∏—Å–æ–∫</p>';
                }
                
                document.getElementById('userSubscriptionsContent').innerHTML = content;
                new bootstrap.Modal(document.getElementById('userSubscriptionsModal')).show();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–¥–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }
        });
}

function deleteUser(userId, userName) {
    currentUserId = userId;
    document.getElementById('deleteUserName').textContent = userName;
    new bootstrap.Modal(document.getElementById('deleteUserModal')).show();
}

function confirmDeleteUser() {
    if (!currentUserId) return;
    
    fetch(`/api/user/${currentUserId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω');
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + data.message);
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
    });
}

function refreshUsers() {
    location.reload();
}

function applyFilters() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const subscriptionFilter = document.getElementById('subscriptionFilter').value;
    
    const rows = document.querySelectorAll('#usersTable tbody tr');
    
    rows.forEach(row => {
        const name = row.cells[1].textContent.toLowerCase();
        const email = row.cells[3].textContent.toLowerCase();
        const subscriptions = row.cells[5].textContent;
        
        let show = true;
        
        // –ü–æ–∏—Å–∫
        if (search && !name.includes(search) && !email.includes(search)) {
            show = false;
        }
        
        // –§–∏–ª—å—Ç—Ä –ø–æ–¥–ø–∏—Å–æ–∫
        if (subscriptionFilter === 'has_subscription' && !subscriptions.includes('–∞–∫—Ç–∏–≤–Ω—ã—Ö')) {
            show = false;
        } else if (subscriptionFilter === 'no_subscription' && subscriptions.includes('–∞–∫—Ç–∏–≤–Ω—ã—Ö')) {
            show = false;
        }
        
        row.style.display = show ? '' : 'none';
    });
}

// –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∏ –≤–≤–æ–¥–µ
document.getElementById('searchInput').addEventListener('input', applyFilters);
document.getElementById('statusFilter').addEventListener('change', applyFilters);
document.getElementById('subscriptionFilter').addEventListener('change', applyFilters);
</script>
{% endblock %}
