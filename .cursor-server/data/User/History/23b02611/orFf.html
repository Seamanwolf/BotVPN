{% extends "base.html" %}

{% block title %}Администраторы - SeaVPN Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Администраторы</h1>
        <div class="d-flex gap-2">
            <button class="btn btn-success" onclick="addAdminModal()">
                <i class="fas fa-plus"></i> Добавить администратора
            </button>
            <button class="btn btn-primary" onclick="refreshAdmins()">
                <i class="fas fa-refresh"></i> Обновить
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Список администраторов</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Telegram ID</th>
                                    <th>Имя пользователя</th>
                                    <th>Полное имя</th>
                                    <th>Дата добавления</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="adminsTable">
                                {% for admin in admins %}
                                <tr>
                                    <td>
                                        <span class="badge bg-primary">{{ admin.telegram_id }}</span>
                                    </td>
                                    <td>{{ admin.username or 'Не указан' }}</td>
                                    <td>{{ admin.full_name or 'Не указано' }}</td>
                                    <td>{{ admin.added_at.strftime('%d.%m.%Y %H:%M') if admin.added_at else 'Не указано' }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-info" onclick="viewAdminDetails({{ admin.telegram_id }})">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% if admin.telegram_id != 261337953 %}
                                            <button class="btn btn-outline-danger" onclick="removeAdmin({{ admin.telegram_id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Информация</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> О системе администраторов</h6>
                        <ul class="mb-0">
                            <li>Администраторы имеют доступ к админ-панели</li>
                            <li>Главный администратор (ID: 261337953) не может быть удален</li>
                            <li>Для добавления администратора нужен его Telegram ID</li>
                            <li>Изменения вступают в силу после перезапуска бота</li>
                        </ul>
                    </div>
                    
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle"></i> Важно</h6>
                        <p class="mb-0">После добавления/удаления администраторов необходимо перезапустить Telegram бота для применения изменений.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно добавления администратора -->
<div class="modal fade" id="addAdminModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить администратора</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addAdminForm">
                    <div class="mb-3">
                        <label for="telegramId" class="form-label">Telegram ID *</label>
                        <input type="number" class="form-control" id="telegramId" required>
                        <div class="form-text">Введите Telegram ID пользователя, которого хотите сделать администратором</div>
                    </div>
                    <div class="mb-3">
                        <label for="adminNote" class="form-label">Примечание</label>
                        <input type="text" class="form-control" id="adminNote" placeholder="Опционально">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="addAdmin()">Добавить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно с деталями администратора -->
<div class="modal fade" id="adminDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Детали администратора</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="adminDetailsContent">
                <!-- Контент будет загружен динамически -->
            </div>
        </div>
    </div>
</div>

<script>
function refreshAdmins() {
    location.reload();
}

function addAdminModal() {
    document.getElementById('addAdminForm').reset();
    new bootstrap.Modal(document.getElementById('addAdminModal')).show();
}

function addAdmin() {
    const telegramId = document.getElementById('telegramId').value;
    const note = document.getElementById('adminNote').value;
    
    if (!telegramId) {
        alert('Введите Telegram ID');
        return;
    }
    
    fetch('/api/admin/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
            telegram_id: parseInt(telegramId),
            note: note 
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Администратор успешно добавлен!');
            bootstrap.Modal.getInstance(document.getElementById('addAdminModal')).hide();
            location.reload();
        } else {
            alert('Ошибка добавления: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка добавления администратора');
    });
}

function removeAdmin(telegramId) {
    if (confirm(`Вы уверены, что хотите удалить администратора с Telegram ID ${telegramId}?`)) {
        fetch(`/api/admin/remove`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ telegram_id: telegramId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Администратор успешно удален!');
                location.reload();
            } else {
                alert('Ошибка удаления: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ошибка удаления администратора');
        });
    }
}

function viewAdminDetails(telegramId) {
    fetch(`/api/admin/${telegramId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const admin = data.admin;
                const user = data.user;
                
                document.getElementById('adminDetailsContent').innerHTML = `
                    <div class="row">
                        <div class="col-12">
                            <h6>Информация об администраторе</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Telegram ID:</strong></td><td>${admin.telegram_id}</td></tr>
                                <tr><td><strong>Дата добавления:</strong></td><td>${admin.added_at ? new Date(admin.added_at).toLocaleString('ru-RU') : 'Не указано'}</td></tr>
                                <tr><td><strong>Примечание:</strong></td><td>${admin.note || 'Не указано'}</td></tr>
                            </table>
                        </div>
                    </div>
                    ${user ? `
                    <hr>
                    <div class="row">
                        <div class="col-12">
                            <h6>Информация о пользователе</h6>
                            <table class="table table-sm">
                                <tr><td><strong>ID:</strong></td><td>${user.id}</td></tr>
                                <tr><td><strong>Имя:</strong></td><td>${user.full_name || 'Не указано'}</td></tr>
                                <tr><td><strong>Email:</strong></td><td>${user.email || 'Не указан'}</td></tr>
                                <tr><td><strong>Дата регистрации:</strong></td><td>${user.created_at ? new Date(user.created_at).toLocaleDateString('ru-RU') : 'Не указано'}</td></tr>
                                <tr><td><strong>Подписок:</strong></td><td>${user.subscriptions ? user.subscriptions.length : 0}</td></tr>
                            </table>
                        </div>
                    </div>
                    ` : '<hr><div class="alert alert-warning">Пользователь не найден в базе данных</div>'}
                `;
                
                new bootstrap.Modal(document.getElementById('adminDetailsModal')).show();
            } else {
                alert('Ошибка загрузки данных администратора');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ошибка загрузки данных администратора');
        });
}
</script>
{% endblock %}
