<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SeaVPN - Вход в админ-панель</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1e40af;
            --primary-hover: #1d4ed8;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --text-primary: #0f172a;
            --border-color: #e2e8f0;
            --header-bg: #f1f5f9;
            --header-text: #0f172a;
        }
        body { background-color: var(--bg-secondary); color: var(--text-primary); min-height: 100vh; display: flex; align-items: center; justify-content: center; font-family: 'Poppins', sans-serif; }
        .login-card {
            background: var(--bg-primary);
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            max-width: 400px;
            width: 100%;
        }
        .login-header {
            background: var(--header-bg);
            color: var(--header-text);
            padding: 1.5rem;
            border-radius: 1rem 1rem 0 0;
            text-align: center;
        }
        .login-body {
            padding: 1.5rem;
        }
        .form-control {
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
        }
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(58, 134, 255, 0.25);
        }
        .brand-badge { display: inline-flex; align-items: center; gap: 8px; font-weight: 600; }
        .brand-badge i { color: var(--primary-color); }
        .text-muted-sm { font-size: 0.9rem; color: #64748b; }
    </style>
</head>
<body>
    <div class="login-card">
        <div class="login-header">
            <div class="brand-badge">
                <i class="fas fa-water"></i>
                <span>SeaVPN</span>
            </div>
            <p class="mb-0 text-muted-sm">Вход в админ-панель</p>
        </div>
        
        <div class="login-body">
            {% with messages = get_flashed_messages() %}
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>{{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <form method="POST">
                <div class="mb-3">
                    <label for="username" class="form-label">
                        <i class="fas fa-user me-2"></i>Логин
                    </label>
                    <input type="text" class="form-control" id="username" name="username" required>
                </div>
                
                <div class="mb-4">
                    <label for="password" class="form-label">
                        <i class="fas fa-lock me-2"></i>Пароль
                    </label>
                    <input type="password" class="form-control" id="password" name="password" required>
                </div>
                <div class="mb-4">
                    <label for="totp" class="form-label">
                        <i class="fas fa-mobile-alt me-2"></i>2FA код (если включен)
                    </label>
                    <input type="text" inputmode="numeric" maxlength="6" autocomplete="one-time-code" class="form-control" id="totp" name="totp" placeholder="6-значный код">
                </div>
                
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-sign-in-alt me-2"></i>Войти
                </button>
            </form>
            
            <div class="text-center mt-3">
                <a href="#" onclick="showRecoveryModal()" class="text-decoration-none">
                    <i class="fas fa-question-circle me-1"></i>
                    Забыли пароль или 2FA?
                </a>
            </div>
        </div>
    </div>

    <!-- Модальное окно восстановления доступа -->
    <div class="modal fade" id="recoveryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-lock me-2"></i>
                        Восстановление доступа
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3" style="font-size: 0.8rem;">Выберите способ восстановления доступа к панели администратора</p>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-sm" onclick="showRequestForm('admin')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                            <i class="fas fa-user-shield me-1"></i>
                            Запросить доступ у администратора
                        </button>
                        
                        <button class="btn btn-warning btn-sm" onclick="showRequestForm('password')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                            <i class="fas fa-key me-1"></i>
                            Запросить сброс пароля
                        </button>
                        
                        <button class="btn btn-info btn-sm" onclick="showRequestForm('2fa')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                            <i class="fas fa-mobile-alt me-1"></i>
                            Запросить сброс 2FA
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для запроса -->
    <div class="modal fade" id="requestFormModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="requestFormTitle">Запрос восстановления</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="recoveryForm">
                        <div class="mb-3">
                            <label for="username" class="form-label" style="font-size: 0.9rem;">
                                <i class="fas fa-user me-2"></i>Имя пользователя
                            </label>
                            <input type="text" class="form-control form-control-sm" id="username" name="username" required style="font-size: 0.8rem;">
                        </div>
                        <div class="mb-3">
                            <label for="reason" class="form-label" style="font-size: 0.9rem;">
                                <i class="fas fa-comment me-2"></i>Причина запроса
                            </label>
                            <textarea class="form-control form-control-sm" id="reason" name="reason" rows="3" required 
                                      placeholder="Опишите, почему вам нужен доступ..." style="font-size: 0.8rem;"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="contact" class="form-label" style="font-size: 0.9rem;">
                                <i class="fas fa-phone me-2"></i>Контакт для связи
                            </label>
                            <input type="text" class="form-control form-control-sm" id="contact" name="contact" required
                                   placeholder="Telegram username или email" style="font-size: 0.8rem;">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal" style="font-size: 0.8rem;">Отмена</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="submitRecoveryRequest()" style="font-size: 0.8rem;">
                        <i class="fas fa-paper-plane me-2"></i>Отправить запрос
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentRequestType = '';
        const recoveryModal = new bootstrap.Modal(document.getElementById('recoveryModal'));
        const requestFormModal = new bootstrap.Modal(document.getElementById('requestFormModal'));
        
        function showRecoveryModal() {
            recoveryModal.show();
        }
        
        function showRequestForm(type) {
            currentRequestType = type;
            const titles = {
                'admin': 'Запрос доступа у администратора',
                'password': 'Запрос сброса пароля',
                '2fa': 'Запрос сброса 2FA'
            };
            
            document.getElementById('requestFormTitle').textContent = titles[type];
            document.getElementById('recoveryForm').reset();
            recoveryModal.hide();
            requestFormModal.show();
        }
        
        function submitRecoveryRequest() {
            const form = document.getElementById('recoveryForm');
            const formData = new FormData(form);
            formData.append('request_type', currentRequestType);
            
            fetch('/api/recovery/request', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccessMessage('Запрос отправлен! Администратор уведомлен и свяжется с вами.');
                    requestFormModal.hide();
                } else {
                    showErrorMessage('Ошибка: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                showErrorMessage('Произошла ошибка при отправке запроса');
            });
        }
        
        // Функции для красивых уведомлений
        function showSuccessMessage(message) {
            showNotification(message, 'success');
        }
        
        function showErrorMessage(message) {
            showNotification(message, 'error');
        }
        
        function showNotification(message, type = 'info') {
            const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : 'alert-info';
            const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
            
            const notification = document.createElement('div');
            notification.className = `alert ${alertClass} alert-dismissible fade show`;
            notification.innerHTML = `
                <i class="fas ${icon} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Добавляем уведомление в начало формы
            const form = document.getElementById('recoveryForm');
            form.parentNode.insertBefore(notification, form);
            
            // Автоматически скрываем через 5 секунд
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
