{% extends "base.html" %}

{% block title %}Тикеты{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Тикеты</h1>
        <div>
            <button class="btn btn-primary" onclick="refreshTickets()">
                <i class="fas fa-sync-alt"></i> Обновить
            </button>
        </div>
    </div>

    <!-- Фильтры -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <input type="text" class="form-control" id="searchInput" placeholder="Поиск по теме или имени...">
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="statusFilter">
                        <option value="">Все статусы</option>
                        <option value="open">Открытые</option>
                        <option value="closed">Закрытые</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary" onclick="applyFilters()">
                        <i class="fas fa-filter"></i> Применить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Таблица тикетов -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped" id="ticketsTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Пользователь</th>
                            <th>Тема</th>
                            <th>Статус</th>
                            <th>Создан</th>
                            <th>Обновлен</th>
                            <th>Сообщений</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ticket in tickets %}
                        <tr data-ticket-id="{{ ticket.id }}" data-ticket-number="{{ ticket.ticket_number }}">
                            <td>{{ ticket.ticket_number }}</td>
                            <td>
                                {% if ticket.user %}
                                <a href="#" onclick="viewUserDetails({{ ticket.user.id }})">{{ ticket.user.full_name }}</a>
                                {% else %}
                                Неизвестный пользователь
                                {% endif %}
                            </td>
                            <td>{{ ticket.subject }}</td>
                            <td>
                                {% if ticket.status == 'open' %}
                                <span class="badge bg-success">Открыт</span>
                                {% else %}
                                <span class="badge bg-secondary">Закрыт</span>
                                {% endif %}
                            </td>
                            <td>{{ ticket.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>{{ ticket.updated_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>{{ ticket.messages|length }}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="viewTicketDetails({{ ticket.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if ticket.status == 'open' %}
                                <button class="btn btn-sm btn-success" onclick="replyToTicket({{ ticket.id }})">
                                    <i class="fas fa-reply"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="closeTicket({{ ticket.id }})">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно деталей тикета -->
<div class="modal fade" id="ticketDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Детали тикета</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="ticketDetailsContent">
                <!-- Контент будет загружен динамически -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <div id="ticketActionButtons">
                    <!-- Кнопки действий будут добавлены динамически -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно ответа на тикет -->
<div class="modal fade" id="replyTicketModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ответ на тикет</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="replyTicketId" value="">
                <div class="mb-3">
                    <label for="replyMessage" class="form-label">Сообщение</label>
                    <textarea class="form-control" id="replyMessage" rows="5" placeholder="Введите ваш ответ..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="sendReply()">Отправить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно закрытия тикета -->
<div class="modal fade" id="closeTicketModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Закрытие тикета</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="closeTicketId" value="">
                <p>Вы действительно хотите закрыть тикет?</p>
                <div class="mb-3">
                    <label for="closeMessage" class="form-label">Сообщение (необязательно)</label>
                    <textarea class="form-control" id="closeMessage" rows="3" placeholder="Введите сообщение для пользователя..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" onclick="confirmCloseTicket()">Закрыть тикет</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentTicketId = null;

function viewTicketDetails(ticketId) {
    currentTicketId = ticketId;
    
    fetch(`/api/ticket/${ticketId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const ticket = data.ticket;
                const messages = data.messages;
                
                let content = `
                    <div class="ticket-header mb-4">
                        <h6>Информация о тикете</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Номер тикета:</strong> ${ticket.ticket_number}</p>
                                <p><strong>Тема:</strong> ${ticket.subject}</p>
                                <p><strong>Статус:</strong> <span class="badge ${ticket.status === 'open' ? 'bg-success' : 'bg-secondary'}">${ticket.status === 'open' ? 'Открыт' : 'Закрыт'}</span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Создан:</strong> ${new Date(ticket.created_at).toLocaleString()}</p>
                                <p><strong>Обновлен:</strong> ${new Date(ticket.updated_at).toLocaleString()}</p>
                                <p><strong>Пользователь:</strong> <a href="#" onclick="viewUserDetails(${ticket.user_id})">${ticket.user_name}</a></p>
                            </div>
                        </div>
                    </div>
                    <div class="ticket-messages">
                        <h6>Сообщения</h6>
                        <div class="messages-container">
                `;
                
                messages.forEach(msg => {
                    let messageClass = '';
                    let senderName = '';
                    
                    if (msg.sender_type === 'user') {
                        messageClass = 'user-message';
                        senderName = 'Пользователь';
                    } else if (msg.sender_type === 'admin') {
                        messageClass = 'admin-message';
                        senderName = 'Администратор';
                    } else {
                        messageClass = 'system-message';
                        senderName = 'Система';
                    }
                    
                    content += `
                        <div class="message ${messageClass} mb-3">
                            <div class="message-header d-flex justify-content-between">
                                <span class="sender">${senderName}</span>
                                <span class="time">${new Date(msg.created_at).toLocaleString()}</span>
                            </div>
                            <div class="message-body p-2 border rounded">
                                ${msg.message}
                            </div>
                        </div>
                    `;
                });
                
                content += '</div></div>';
                
                document.getElementById('ticketDetailsContent').innerHTML = content;
                
                // Добавляем кнопки действий
                let actionButtons = '';
                if (ticket.status === 'open') {
                    actionButtons = `
                        <button type="button" class="btn btn-success" onclick="replyToTicket(${ticket.id})">
                            <i class="fas fa-reply"></i> Ответить
                        </button>
                        <button type="button" class="btn btn-danger" onclick="closeTicket(${ticket.id})">
                            <i class="fas fa-times"></i> Закрыть тикет
                        </button>
                    `;
                }
                document.getElementById('ticketActionButtons').innerHTML = actionButtons;
                
                // Показываем модальное окно
                new bootstrap.Modal(document.getElementById('ticketDetailsModal')).show();
            } else {
                showError('Ошибка при загрузке данных тикета');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Произошла ошибка при загрузке данных тикета');
        });
}

function replyToTicket(ticketId) {
    // Скрываем модальное окно деталей тикета, если оно открыто
    const detailsModal = bootstrap.Modal.getInstance(document.getElementById('ticketDetailsModal'));
    if (detailsModal) {
        detailsModal.hide();
    }
    
    // Устанавливаем ID тикета для ответа
    document.getElementById('replyTicketId').value = ticketId;
    document.getElementById('replyMessage').value = '';
    
    // Показываем модальное окно ответа
    new bootstrap.Modal(document.getElementById('replyTicketModal')).show();
}

function sendReply() {
    const ticketId = document.getElementById('replyTicketId').value;
    const message = document.getElementById('replyMessage').value.trim();
    
    if (!message) {
        showError('Пожалуйста, введите сообщение');
        return;
    }
    
    fetch(`/api/ticket/${ticketId}/reply`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Закрываем модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('replyTicketModal'));
            if (modal) {
                modal.hide();
            }
            
            // Показываем сообщение об успехе
            showSuccess('Ответ успешно отправлен');
            
            // Обновляем таблицу тикетов
            setTimeout(() => {
                refreshTickets();
            }, 1000);
        } else {
            showError(`Ошибка: ${data.error || 'Неизвестная ошибка'}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Произошла ошибка при отправке ответа');
    });
}

function closeTicket(ticketId) {
    // Скрываем модальное окно деталей тикета, если оно открыто
    const detailsModal = bootstrap.Modal.getInstance(document.getElementById('ticketDetailsModal'));
    if (detailsModal) {
        detailsModal.hide();
    }
    
    // Устанавливаем ID тикета для закрытия
    document.getElementById('closeTicketId').value = ticketId;
    document.getElementById('closeMessage').value = '';
    
    // Показываем модальное окно закрытия
    new bootstrap.Modal(document.getElementById('closeTicketModal')).show();
}

function confirmCloseTicket() {
    const ticketId = document.getElementById('closeTicketId').value;
    const message = document.getElementById('closeMessage').value.trim();
    
    fetch(`/api/ticket/${ticketId}/close`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ message: message || null })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Закрываем модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('closeTicketModal'));
            if (modal) {
                modal.hide();
            }
            
            // Показываем сообщение об успехе
            showSuccess('Тикет успешно закрыт');
            
            // Обновляем таблицу тикетов
            setTimeout(() => {
                refreshTickets();
            }, 1000);
        } else {
            showError(`Ошибка: ${data.error || 'Неизвестная ошибка'}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Произошла ошибка при закрытии тикета');
    });
}

function refreshTickets() {
    location.reload();
}

function applyFilters() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    
    const rows = document.querySelectorAll('#ticketsTable tbody tr');
    
    rows.forEach(row => {
        const subject = row.cells[2].textContent.toLowerCase();
        const userName = row.cells[1].textContent.toLowerCase();
        const status = row.querySelector('td:nth-child(4) .badge').textContent.toLowerCase();
        
        let show = true;
        
        // Поиск
        if (search && !subject.includes(search) && !userName.includes(search)) {
            show = false;
        }
        
        // Фильтр статуса
        if (statusFilter && statusFilter !== status.toLowerCase()) {
            show = false;
        }
        
        row.style.display = show ? '' : 'none';
    });
}

// Применяем фильтры при вводе
document.getElementById('searchInput').addEventListener('input', applyFilters);
document.getElementById('statusFilter').addEventListener('change', applyFilters);

// Стили для сообщений
document.head.insertAdjacentHTML('beforeend', `
    <style>
        .user-message .message-body {
            background-color: #f0f8ff;
        }
        
        .admin-message .message-body {
            background-color: #f0fff0;
        }
        
        .system-message .message-body {
            background-color: #f5f5f5;
            font-style: italic;
        }
        
        [data-theme="dark"] .user-message .message-body {
            background-color: #1a2236;
        }
        
        [data-theme="dark"] .admin-message .message-body {
            background-color: #1a3626;
        }
        
        [data-theme="dark"] .system-message .message-body {
            background-color: #2d2d2d;
        }
        
        .message-header {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        
        .messages-container {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
`);
</script>
{% endblock %}
